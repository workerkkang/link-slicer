<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Link Slicer â€“ ë¼ì¸ ë§ˆí‚¹ & ì¢Œí‘œ ì¶”ì¶œ</title>
<style>
  :root{
    --border:#cfd4dc; --muted:#6b7280; --accent:#ff4d4f; --bg:#f7f9fc;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; display:flex; min-height:100vh; font-family:system-ui,Segoe UI,Roboto,"Apple SD Gothic Neo",Pretendard,sans-serif;
    background:var(--bg); color:#111827;
  }

  /* ì™¼ìª½ ì‚¬ì´ë“œë°”(ì‚¬ìš©ë²• + ì—…ë¡œë“œ ë°•ìŠ¤) */
  #sidebar{
    width:300px; border-right:1px solid var(--border); background:#fff; display:flex; flex-direction:column;
  }
  .side-header{padding:18px 16px; border-bottom:1px solid var(--border)}
  .side-header h2{margin:0;font-size:18px}
  .side-body{padding:16px; overflow:auto}
  .muted{color:var(--muted)}
  ul{margin:8px 0 0 18px}

  /* ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ ë°•ìŠ¤ */
  #dropzone{
    margin-top:12px; border:2px dashed #9ca3af; border-radius:12px; background:#fafafa;
    padding:18px; text-align:center; cursor:pointer; transition:all .15s ease;
  }
  #dropzone.dragover{ border-color:var(--accent); background:#fff1f1 }
  #fileInput{ display:none }

  /* ë©”ì¸ ì˜ì—­ */
  #main{ flex:1; display:flex; flex-direction:column; min-width:0; }
  #controls{ padding:12px; border-bottom:1px solid var(--border); background:#fff; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  #controls button{
    appearance:none; border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
  }
  #controls button.primary{ border-color:#dbe3ff; background:#eef3ff }
  #controls .pill{font-size:12px;color:#4b5563}

  /* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ(ì´ë¯¸ì§€ + ë¼ì¸) */
  #canvas-container{
    position:relative; flex:1; overflow:auto; background:#e5e7eb;
    display:flex; align-items:flex-start; justify-content:center; padding:18px;
  }
  #stage{
    position:relative; /* ë¼ì¸ì˜ ê¸°ì¤€ ì»¨í…Œì´ë„ˆ */
    display:inline-block; background:#fff; border:1px solid var(--border); box-shadow:0 2px 8px rgba(0,0,0,.05);
  }
  #uploadedImage{ display:block; max-width:100%; height:auto; }

  /* ë¼ì¸ ìŠ¤íƒ€ì¼(ë¹¨ê°•) */
  .line{
    position:absolute; background:var(--accent); cursor:move; z-index:5;
    box-shadow:0 0 6px rgba(255,77,79,.45);
  }
  .h-line{ height:2px; left:0; right:0; }
  .v-line{ width:2px;  top:0;  bottom:0; }

  /* í‘¸í„° */
  footer{padding:10px 12px; border-top:1px solid var(--border); background:#fff; font-size:12px;color:#6b7280}
</style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°”: ì‚¬ìš©ë²• + ì—…ë¡œë“œ ë°•ìŠ¤ -->
<aside id="sidebar">
  <div class="side-header">
    <h2>ğŸ“Œ ì‚¬ìš©ë²• ìš”ì•½</h2>
  </div>
  <div class="side-body">
    <ol style="margin:0;padding-left:20px">
      <li>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ(ì•„ë˜ ë°•ìŠ¤ì— <b>ë“œë˜ê·¸&ë“œë¡­</b> ë˜ëŠ” í´ë¦­)</li>
      <li>ì´ë¯¸ì§€ ìœ„ì—ì„œ í´ë¦­:
        <ul>
          <li>ì¼ë°˜ í´ë¦­ â†’ <b>ê°€ë¡œì„ </b></li>
          <li><kbd>Shift</kbd>+í´ë¦­ â†’ <b>ì„¸ë¡œì„ </b></li>
          <li><kbd>Alt</kbd>+í´ë¦­ â†’ <b>ê°€ê¹Œìš´ ì„  ì‚­ì œ</b></li>
        </ul>
      </li>
      <li>ì„ ì„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •</li>
      <li>ìƒë‹¨ì—ì„œ <b>Export JSON</b>ìœ¼ë¡œ ì¢Œí‘œ(ì›ë³¸ pxÂ·%) ì¶”ì¶œ</li>
    </ol>

    <!-- ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ -->
    <div id="dropzone">
      <div style="font-weight:600; margin-bottom:4px;">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
      <div class="muted">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
      <div style="font-size:12px;color:#9ca3af;margin-top:6px;">(PNG Â· JPG Â· GIF)</div>
      <input id="fileInput" type="file" accept="image/*">
    </div>
  </div>
  <footer>Tip: ì°½ í¬ê¸°ë¥¼ ë°”ê¿”ë„ ë¼ì¸ì´ ìœ ì§€ë˜ë„ë¡ <b>ë¹„ìœ¨(%)</b>ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</footer>
</aside>

<!-- ë©”ì¸ -->
<main id="main">
  <div id="controls">
    <button id="btnExport" class="primary">Export JSON</button>
    <button id="btnClearLines">Clear Lines</button>
    <span class="pill">ì¼ë°˜ í´ë¦­=ê°€ë¡œ | Shift=ì„¸ë¡œ | Alt=ì‚­ì œ</span>
  </div>

  <div id="canvas-container">
    <div id="stage" style="display:none">
      <img id="uploadedImage" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">
    </div>
  </div>
</main>

<script>
(() => {
  // ìš”ì†Œ ì°¸ì¡°
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const stage = document.getElementById('stage');
  const image = document.getElementById('uploadedImage');
  const container = document.getElementById('canvas-container');
  const btnExport = document.getElementById('btnExport');
  const btnClearLines = document.getElementById('btnClearLines');

  // ìƒíƒœ
  let lines = []; // { type: 'h'|'v', perc: number, el: HTMLElement }
  let naturalW = 0, naturalH = 0;

  // ========== ì—…ë¡œë“œ(í´ë¦­/ë“œë˜ê·¸) ==========
  function loadFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    image.onload = () => {
      // ì›ë³¸ í•´ìƒë„ í™•ë³´
      naturalW = image.naturalWidth;
      naturalH = image.naturalHeight;
      // ìŠ¤í…Œì´ì§€ í‘œì‹œ ë° ë¼ì¸ ì´ˆê¸°í™”
      stage.style.display = 'inline-block';
      clearLines();
      // ë ˆì´ì•„ì›ƒ ê°±ì‹ 
      layoutLines();
    };
    image.src = url;
  }

  // í´ë¦­ ì—…ë¡œë“œ
  dropzone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    loadFile(f);
  });

  // ë“œë˜ê·¸&ë“œë¡­
  ;['dragenter','dragover'].forEach(ev =>
    dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='copy'; dropzone.classList.add('dragover'); })
  );
  ;['dragleave','dragend','drop'].forEach(ev =>
    dropzone.addEventListener(ev, ()=> dropzone.classList.remove('dragover'))
  );
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f && f.type.startsWith('image/')) loadFile(f);
  });

  // ========== ì¢Œí‘œ ë„ìš°ë¯¸ ==========
  /** í˜„ì¬ í‘œì‹œ í¬ê¸°(ë Œë” í¬ê¸°) */
  function displaySize(){
    const w = image.clientWidth;
    const h = image.clientHeight;
    return { w, h };
  }

  /** ì»¨í…Œì´ë„ˆ ë‚´ í´ë¦­ ì¢Œí‘œ(ìŠ¤í¬ë¡¤ ë³´ì • í¬í•¨) */
  function pointerInStage(ev){
    const rect = stage.getBoundingClientRect();
    const x = ev.clientX - rect.left + container.scrollLeft;
    const y = ev.clientY - rect.top  + container.scrollTop;
    const { w, h } = displaySize();
    const inside = x >= 0 && y >= 0 && x <= w && y <= h;
    return { x, y, inside, w, h };
  }

  /** ë¼ì¸ DOM ì¬ë°°ì¹˜(perc -> display px) */
  function layoutLines(){
    const { w, h } = displaySize();
    lines.forEach(l => {
      if (l.type === 'h') {
        l.el.style.top  = (l.perc * h) + 'px';
        l.el.style.left = 0;
        l.el.style.right = 0;
        l.el.className = 'line h-line';
      } else {
        l.el.style.left = (l.perc * w) + 'px';
        l.el.style.top  = 0;
        l.el.style.bottom = 0;
        l.el.className = 'line v-line';
      }
    });
  }

  // ========== ë¼ì¸ ìƒì„±/ì‚­ì œ/ë“œë˜ê·¸ ==========
  function createLine(type, perc){
    const el = document.createElement('div');
    el.className = type === 'h' ? 'line h-line' : 'line v-line';
    stage.appendChild(el);

    const obj = { type, perc, el };
    lines.push(obj);
    layoutLines();

    // ë“œë˜ê·¸ ì´ë™
    let dragging = false, startClient = 0, startPerc = 0;
    el.addEventListener('mousedown', (e) => {
      e.preventDefault();
      dragging = true;
      startClient = (type === 'h') ? e.clientY : e.clientX;
      startPerc = obj.perc;

      const onMove = (ev) => {
        if (!dragging) return;
        const { w, h } = displaySize();
        const delta = (type === 'h') ? (ev.clientY - startClient) / h
                                     : (ev.clientX - startClient) / w;
        obj.perc = Math.max(0, Math.min(1, startPerc + delta));
        layoutLines();
      };
      const onUp = () => {
        dragging = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      };
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });

    return obj;
  }

  function deleteNearest(x, y){
    if (lines.length === 0) return;
    const { w, h } = displaySize();
    let nearest = null, distMin = Infinity;

    lines.forEach(l => {
      const d = (l.type === 'h')
        ? Math.abs((l.perc * h) - y)
        : Math.abs((l.perc * w) - x);
      if (d < distMin) { distMin = d; nearest = l; }
    });

    if (nearest) {
      nearest.el.remove();
      lines = lines.filter(l => l !== nearest);
    }
  }

  function clearLines(){
    lines.forEach(l => l.el && l.el.remove());
    lines = [];
  }

  // ========== í´ë¦­ ì´ë²¤íŠ¸(ê°€ë¡œ/ì„¸ë¡œ/ì‚­ì œ) ==========
  stage.addEventListener('click', (e) => {
    if (!image.src) return;
    const p = pointerInStage(e);
    if (!p.inside) return;

    // Alt: ê°€ì¥ ê°€ê¹Œìš´ ì„  ì‚­ì œ
    if (e.altKey){ deleteNearest(p.x, p.y); return; }

    // Shift: ì„¸ë¡œì„ , ì¼ë°˜: ê°€ë¡œì„ 
    if (e.shiftKey) {
      const perc = p.x / p.w;
      createLine('v', perc);
    } else {
      const perc = p.y / p.h;
      createLine('h', perc);
    }
  });

  // ========== ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘(ë¹„ìœ¨ ê¸°ë°˜ ì¬ë°°ì¹˜) ==========
  const ro = new ResizeObserver(() => layoutLines());
  ro.observe(stage);
  ro.observe(image);

  // ========== Export / Clear ==========
  btnExport.addEventListener('click', () => {
    if (!image.src) { alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.'); return; }
    const data = lines.map(l => {
      // ì›ë³¸(px) ì¢Œí‘œë¡œ í™˜ì‚°
      const px = (l.type === 'h') ? Math.round(l.perc * naturalH)
                                  : Math.round(l.perc * naturalW);
      const percent = (l.perc * 100).toFixed(2);
      return { type: l.type, pixel_natural: px, percent };
    });
    const json = JSON.stringify({ naturalWidth:naturalW, naturalHeight:naturalH, lines:data }, null, 2);
    // ê²°ê³¼ í‘œì‹œ
    const w = window.open('', '_blank', 'width=520,height=640');
    w.document.write(`<pre style="margin:0;padding:12px;white-space:pre-wrap;word-break:break-all;">${json}</pre>`);
    w.document.title = 'Link Slicer Export';
  });

  btnClearLines.addEventListener('click', clearLines);
})();
</script>
</body>
</html>
