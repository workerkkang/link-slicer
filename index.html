<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Link Slicer â€“ ë¶„í• ì„  & ë§í¬ ìƒì„±ê¸°(ì¸ë„¤ì¼Â·ì¬ìƒì„±Â·ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°)</title>
<style>
  :root{ --border:#cfd4dc; --muted:#6b7280; --accent:#ff4d4f; --bg:#f7f9fc; --panel:#ffffff; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; display:flex; min-height:100vh; font-family:system-ui,Segoe UI,Roboto,"Apple SD Gothic Neo",Pretendard,sans-serif; background:var(--bg); color:#111827; }

  /* ì™¼ìª½: ì‚¬ìš©ë²• + ì—…ë¡œë“œ */
  #sidebar{ width:300px; border-right:1px solid var(--border); background:var(--panel); display:flex; flex-direction:column; }
  .side-header{padding:18px 16px; border-bottom:1px solid var(--border)}
  .side-header h2{margin:0;font-size:18px}
  .side-body{padding:16px; overflow:auto}
  .muted{color:var(--muted)}
  ul{margin:8px 0 0 18px}
  footer{padding:10px 12px; border-top:1px solid var(--border); background:#fff; font-size:12px;color:#6b7280}

  /* ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ ë°•ìŠ¤ */
  #dropzone{
    margin-top:12px; border:2px dashed #9ca3af; border-radius:12px; background:#fafafa;
    padding:18px; text-align:center; cursor:pointer; transition:all .15s ease;
  }
  #dropzone.dragover{ border-color:var(--accent); background:#fff1f1 }
  #fileInput{ display:none }

  /* ê°€ìš´ë°: ì‘ì—… ì˜ì—­ */
  #main{ flex:1; display:flex; flex-direction:column; min-width:0; }
  #topbar{ padding:12px; border-bottom:1px solid var(--border); background:#fff; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  #topbar button{ appearance:none; border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
  #topbar button.primary{ border-color:#dbe3ff; background:#eef3ff }
  #topbar .pill{font-size:12px;color:#4b5563}
  #topbar .spacer{ flex:1 }

  #workarea{ display:grid; grid-template-columns:1fr 380px; gap:14px; padding:14px; min-height:0; flex:1; overflow:hidden; }

  /* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ(ìŠ¤í¬ë¡¤ ì˜ì—­) */
  #canvas-container{
    position:relative; overflow:auto; background:#e5e7eb; border:1px solid var(--border); border-radius:10px;
    display:flex; align-items:flex-start; justify-content:center; padding:18px; min-height:0;
  }

  /* ìŠ¤í…Œì´ì§€: ì´ë¯¸ì§€ + ì˜¤ë²„ë ˆì´ ë¬¶ìŒ */
  #stage{ position:relative; display:none; }
  #uploadedImage{ display:block; max-width:100%; height:auto; border:1px solid var(--border); background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.05); }

  /* ì˜¤ë²„ë ˆì´ */
  #overlay{ position:absolute; left:0; top:0; z-index:10; pointer-events:auto; }

  /* ì„  */
  .line{ position:absolute; background:var(--accent); cursor:move; box-shadow:0 0 6px rgba(255,77,79,.45); pointer-events:auto; }
  .h-line{ height:2px; left:0; right:0; }
  .v-line{ width:2px;  top:0;  bottom:0; }

  /* ìš°ì¸¡: ë§í¬/ì½”ë“œ/ë¯¸ë¦¬ë³´ê¸° */
  #rightpanel{ background:#fff; border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; min-height:0; }
  #rightpanel header{ padding:12px 12px; border-bottom:1px solid var(--border); font-weight:600 }
  #segments{ padding:12px; overflow:auto; display:flex; flex-direction:column; gap:10px; min-height:0; }

  /* ì¸ë„¤ì¼ + ì…ë ¥ */
  .segrow{
    display:grid; grid-template-columns:76px 1fr; gap:10px; align-items:center; border:1px solid var(--border);
    padding:8px; border-radius:10px; background:#fafafa;
  }
  .thumb{ width:76px; height:auto; border:1px solid var(--border); border-radius:6px; display:block; background:#fff; }
  .segmeta{ font-size:12px; color:#6b7280; margin-top:4px }
  .segrow input{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; }

  #codebox{ padding:12px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:8px; }
  #code{ width:100%; min-height:120px; border:1px solid var(--border); border-radius:8px; padding:10px; font-family:ui-monospace,Consolas,monospace; }

  #previewwrap{ padding:12px; border-top:1px solid var(--border); }
  #preview{ display:flex; flex-direction:column; gap:4px; }

  /* ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ì…ë ¥ ìˆ¨ê¹€ */
  #stateFile{ display:none }

  @media (max-width: 1120px){ #workarea{ grid-template-columns:1fr; } }
</style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” -->
<aside id="sidebar">
  <div class="side-header"><h2>ğŸ“Œ ì‚¬ìš©ë²• ìš”ì•½</h2></div>
  <div class="side-body">
    <ol style="margin:0;padding-left:20px">
      <li>ì´ë¯¸ì§€ ì—…ë¡œë“œ(ì•„ë˜ ë°•ìŠ¤ì— <b>ë“œë˜ê·¸&ë“œë¡­</b> ë˜ëŠ” í´ë¦­)</li>
      <li>ì´ë¯¸ì§€ ìœ„ í´ë¦­:
        <ul>
          <li>ì¼ë°˜ í´ë¦­ â†’ <b>ê°€ë¡œì„ </b></li>
          <li><kbd>Shift</kbd>+í´ë¦­ â†’ <b>ì„¸ë¡œì„ </b></li>
          <li><kbd>Alt</kbd>+í´ë¦­ â†’ <b>ê°€ê¹Œìš´ ì„  ì‚­ì œ</b></li>
        </ul>
      </li>
      <li>ì„ ì„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •</li>
      <li>ìš°ì¸¡ íŒ¨ë„ì—ì„œ ê° ì¡°ê° <b>ë§í¬</b> ì…ë ¥ â†’ <b>HTML ìƒì„±/ë³µì‚¬</b></li>
    </ol>
    <div id="dropzone">
      <div style="font-weight:600; margin-bottom:4px;">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
      <div class="muted">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
      <div style="font-size:12px;color:#9ca3af;margin-top:6px;">(PNG Â· JPG Â· GIF)</div>
      <input id="fileInput" type="file" accept="image/*">
    </div>
  </div>
  <footer>ê¸´ ì´ë¯¸ì§€ë„ ì •í™•íˆ í‘œì‹œë©ë‹ˆë‹¤. ê°€ë¡œì„  ê¸°ì¤€ìœ¼ë¡œ ì¡°ê°Â·ì¸ë„¤ì¼ì„ êµ¬ì„±í•©ë‹ˆë‹¤.</footer>
</aside>

<!-- ë©”ì¸ -->
<main id="main">
  <div id="topbar">
    <button id="btnGen" class="primary" disabled>HTML ìƒì„±</button>
    <button id="btnRegen" disabled>HTML ì¬ìƒì„±</button>
    <button id="btnCopy" disabled>ì½”ë“œ ë³µì‚¬</button>
    <span class="spacer"></span>
    <button id="btnSaveState" title="í˜„ì¬ ì‘ì—… ì €ì¥(JSON ë‹¤ìš´ë¡œë“œ)">ìƒíƒœ ì €ì¥</button>
    <button id="btnLoadState" title="ì €ì¥í•œ JSON ë¶ˆëŸ¬ì˜¤ê¸°">ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <input id="stateFile" type="file" accept="application/json" />
    <button id="btnClearLines">ì„  ëª¨ë‘ ì‚­ì œ</button>
    <span class="pill">ì¼ë°˜ í´ë¦­=ê°€ë¡œ | Shift=ì„¸ë¡œ | Alt=ì‚­ì œ</span>
  </div>

  <div id="workarea">
    <!-- ì¢Œì¸¡: ì´ë¯¸ì§€/ì˜¤ë²„ë ˆì´ -->
    <div id="canvas-container">
      <div id="stage">
        <img id="uploadedImage" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€">
        <div id="overlay"></div>
      </div>
    </div>

    <!-- ìš°ì¸¡: ë§í¬/ì½”ë“œ/ë¯¸ë¦¬ë³´ê¸° -->
    <div id="rightpanel">
      <header>ì¡°ê° ë§í¬ ì…ë ¥(ê°€ë¡œì„  ê¸°ì¤€) + ì¸ë„¤ì¼</header>
      <div id="segments"></div>
      <div id="codebox">
        <button id="btnPreview" disabled>ë¯¸ë¦¬ë³´ê¸° ìƒì„±</button>
        <textarea id="code" placeholder="HTML ìƒì„± í›„ ì½”ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤" readonly></textarea>
      </div>
      <div id="previewwrap">
        <div style="font-weight:600; margin-bottom:8px;">ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="preview"></div>
      </div>
    </div>
  </div>
</main>

<script>
(() => {
  // ìš”ì†Œ
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const stateFile = document.getElementById('stateFile');

  const stage = document.getElementById('stage');
  const overlay = document.getElementById('overlay');
  const image = document.getElementById('uploadedImage');

  const segmentsWrap = document.getElementById('segments');
  const btnGen = document.getElementById('btnGen');
  const btnRegen = document.getElementById('btnRegen');
  const btnCopy = document.getElementById('btnCopy');
  const btnClearLines = document.getElementById('btnClearLines');
  const btnPreview = document.getElementById('btnPreview');
  const btnSaveState = document.getElementById('btnSaveState');
  const btnLoadState = document.getElementById('btnLoadState');
  const codeTA = document.getElementById('code');
  const preview = document.getElementById('preview');

  // ìƒíƒœ
  let lines = []; // { type: 'h'|'v', perc: number, el: HTMLElement }
  let naturalW = 0, naturalH = 0;
  let segLinks = []; // ê° ì¡°ê° ë§í¬
  let thumbRAF = null; // ì¸ë„¤ì¼ ë””ë°”ìš´ìŠ¤ìš©
  let lastGeneratedHTML = ""; // ì¬ìƒì„±/ë³µì‚¬ìš©
  let dirty = true; // ë¼ì¸/ë§í¬ê°€ ë°”ë€ ìƒíƒœ

  // ì—…ë¡œë“œ
  function loadFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    image.onload = () => {
      naturalW = image.naturalWidth;
      naturalH = image.naturalHeight;
      stage.style.display = 'inline-block';
      syncOverlaySize();
      fullReset();
    };
    image.src = url;
  }
  dropzone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => loadFile(e.target.files?.[0]));
  ['dragenter','dragover'].forEach(t => dropzone.addEventListener(t, e => {e.preventDefault(); dropzone.classList.add('dragover');}));
  ['dragleave','dragend','drop'].forEach(t => dropzone.addEventListener(t, () => dropzone.classList.remove('dragover')));
  dropzone.addEventListener('drop', (e) => { e.preventDefault(); const f = e.dataTransfer.files?.[0]; if (f?.type.startsWith('image/')) loadFile(f); });

  // ì˜¤ë²„ë ˆì´/ì¢Œí‘œ
  function syncOverlaySize(){
    overlay.style.width  = image.clientWidth + 'px';
    overlay.style.height = image.clientHeight + 'px';
    overlay.style.left = '0px'; overlay.style.top = '0px';
  }
  function pointerInOverlay(ev){
    const r = overlay.getBoundingClientRect();
    const x = ev.clientX - r.left;
    const y = ev.clientY - r.top;
    const w = overlay.clientWidth, h = overlay.clientHeight;
    return { x, y, w, h, inside: x>=0 && y>=0 && x<=w && y<=h };
  }
  const displaySize = () => ({ w: overlay.clientWidth, h: overlay.clientHeight });

  function layoutLines(){
    const { w, h } = displaySize();
    lines.forEach(l => {
      if (l.type === 'h') { l.el.style.top  = (l.perc*h)+'px'; l.el.className='line h-line'; }
      else                { l.el.style.left = (l.perc*w)+'px'; l.el.className='line v-line'; }
    });
  }

  // ë¼ì¸ ì¡°ì‘
  function markDirty(){ dirty = true; btnRegen.disabled = false; btnPreview.disabled = true; btnCopy.disabled = true; }

  function createLine(type, perc){
    const el = document.createElement('div');
    el.className = type==='h' ? 'line h-line' : 'line v-line';
    overlay.appendChild(el);
    const obj = { type, perc, el };
    lines.push(obj);
    layoutLines();
    updateSegmentsUI(true);
    markDirty();

    // ë“œë˜ê·¸
    let dragging=false, startClient=0, startPerc=0;
    el.addEventListener('mousedown', (e)=>{
      e.preventDefault(); dragging=true;
      startClient = (type==='h')? e.clientY : e.clientX;
      startPerc   = obj.perc;

      const onMove=(ev)=>{
        if(!dragging) return;
        const { w, h } = displaySize();
        const delta = (type==='h') ? (ev.clientY-startClient)/h : (ev.clientX-startClient)/w;
        obj.perc = Math.max(0, Math.min(1, startPerc+delta));
        layoutLines();
        if (type==='h') scheduleThumbs();
        markDirty();
      };
      const onUp=()=>{ dragging=false; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); updateSegmentsUI(false); };
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
    return obj;
  }

  function deleteNearest(x,y){
    if (!lines.length) return;
    const { w,h } = displaySize();
    let nearest=null, dist=Infinity;
    lines.forEach(l=>{
      const d = (l.type==='h')? Math.abs(l.perc*h - y) : Math.abs(l.perc*w - x);
      if (d<dist) {dist=d; nearest=l;}
    });
    if (nearest){
      nearest.el.remove();
      lines = lines.filter(l=>l!==nearest);
      if (nearest.type==='h') updateSegmentsUI(true);
      markDirty();
    }
  }

  function clearLinesUI(){
    segmentsWrap.innerHTML=''; segLinks=[]; codeTA.value=''; preview.innerHTML='';
    btnPreview.disabled = true; btnCopy.disabled = true; btnGen.disabled = lines.filter(l=>l.type==='h').length===0;
  }
  function clearLines(){ lines.forEach(l=>l.el.remove()); lines=[]; clearLinesUI(); markDirty(); }
  function fullReset(){ clearLines(); btnGen.disabled=false; btnRegen.disabled=true; btnPreview.disabled=true; btnCopy.disabled=true; lastGeneratedHTML=""; dirty=true; }

  // í´ë¦­(Alt=ì‚­ì œ / Shift=ì„¸ë¡œ / ê¸°ë³¸=ê°€ë¡œ)
  overlay.addEventListener('click', e=>{
    if (!image.src) return;
    const p = pointerInOverlay(e); if (!p.inside) return;
    if (e.altKey)  { deleteNearest(p.x,p.y); return; }
    if (e.shiftKey){ createLine('v', p.x/p.w); return; }
    createLine('h', p.y/p.h);
  });

  // ë¦¬ì‚¬ì´ì¦ˆ
  const ro = new ResizeObserver(()=>{ syncOverlaySize(); layoutLines(); scheduleThumbs(); });
  ro.observe(image); ro.observe(stage);

  btnClearLines.addEventListener('click', clearLines);

  // ì„¸ê·¸ë¨¼íŠ¸/ì¸ë„¤ì¼
  function getHorizontalPercsSorted(){ return lines.filter(l=>l.type==='h').map(l=>l.perc).sort((a,b)=>a-b); }

  function updateSegmentsUI(regenThumbs){
    const cuts = getHorizontalPercsSorted();
    const bounds = [0, ...cuts, 1];
    const count = Math.max(1, bounds.length-1);
    const prev = segLinks.slice();
    segLinks = Array.from({length:count}, (_,i)=> prev[i] ?? "");

    segmentsWrap.innerHTML = "";
    for (let i=0;i<count;i++){
      const heightPct = ((bounds[i+1]-bounds[i])*100).toFixed(1);
      const row = document.createElement('div');
      row.className='segrow'; row.dataset.idx=i;

      const left = document.createElement('div');
      const img  = document.createElement('img'); img.className='thumb'; img.alt = `seg-${i+1}`;
      left.appendChild(img);
      const meta = document.createElement('div'); meta.className='segmeta'; meta.textContent = `ì¡°ê° ${i+1} Â· ë†’ì´ ${heightPct}%`;
      left.appendChild(meta);

      const input = document.createElement('input');
      input.type='url'; input.placeholder='https:// ë§í¬ ì…ë ¥'; input.value = segLinks[i] ?? '';
      input.addEventListener('input', ev=> { segLinks[i] = ev.target.value.trim(); markDirty(); });

      row.appendChild(left); row.appendChild(input);
      segmentsWrap.appendChild(row);
    }

    btnGen.disabled = !image.src || count<1;
    btnPreview.disabled = true; btnCopy.disabled = true; codeTA.value=''; preview.innerHTML='';
    if (regenThumbs) scheduleThumbs();
  }

  // ì¸ë„¤ì¼ ìƒì„±(ë””ë°”ìš´ìŠ¤)
  function scheduleThumbs(){ if (thumbRAF) cancelAnimationFrame(thumbRAF); thumbRAF = requestAnimationFrame(renderThumbnails); }
  function renderThumbnails(){
    thumbRAF = null; if (!image.src) return;
    const cuts = getHorizontalPercsSorted();
    const boundsPerc = [0, ...cuts, 1];
    const ys = boundsPerc.map(p => Math.round(p * naturalH));

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    for(let i=0;i<ys.length-1;i++){
      const top = ys[i], height = ys[i+1]-ys[i]; if (height<=0) continue;
      const thumbW = 76, thumbH = Math.max(1, Math.round(height * (thumbW / naturalW)));
      canvas.width = thumbW; canvas.height = thumbH;
      ctx.clearRect(0,0,thumbW,thumbH);
      ctx.drawImage(image, 0, top, naturalW, height, 0, 0, thumbW, thumbH);
      const url = canvas.toDataURL('image/png');
      const row = segmentsWrap.querySelector(`.segrow[data-idx="${i}"] img.thumb`);
      if (row) row.src = url;
    }
  }

  // HTML ìƒì„± / ì¬ìƒì„± / ë³µì‚¬
  async function generateHTML(){
    if (!image.src) return;
    const cuts = getHorizontalPercsSorted();
    const boundsPerc = [0, ...cuts, 1];
    const ys = boundsPerc.map(p => Math.round(p * naturalH));

    const canv = document.createElement('canvas'); canv.width = naturalW;
    const ctx = canv.getContext('2d');

    const dataURLs=[];
    for(let i=0;i<ys.length-1;i++){
      const top=ys[i], h=ys[i+1]-ys[i]; if (h<=0) continue;
      canv.height=h; ctx.clearRect(0,0,canv.width,canv.height);
      ctx.drawImage(image, 0, top, naturalW, h, 0, 0, naturalW, h);
      dataURLs.push(canv.toDataURL('image/png'));
    }

    const pieces = dataURLs.map((src,i)=>{
      const href = segLinks[i] || "#";
      return `<a href="${href}" target="_blank" style="display:block;line-height:0;"><img src="${src}" alt="slice-${i+1}" style="display:block;width:100%;height:auto;border:0;"/></a>`;
    }).join("\n");

    lastGeneratedHTML = `<!-- Generated by Link Slicer -->\n<div style="max-width:800px;margin:0 auto;">\n${pieces}\n</div>`;
    codeTA.value = lastGeneratedHTML;
    btnPreview.disabled = false; btnCopy.disabled = false; btnRegen.disabled = false; dirty = false;

    // ë¯¸ë¦¬ë³´ê¸°
    preview.innerHTML="";
    dataURLs.forEach((src,i)=>{
      const a=document.createElement('a'); a.href=segLinks[i]||"#"; a.target="_blank";
      const im=document.createElement('img'); im.src=src; im.alt=`slice-${i+1}`;
      im.style.display="block"; im.style.width="100%"; im.style.height="auto";
      a.appendChild(im); preview.appendChild(a);
    });
  }

  btnGen.addEventListener('click', generateHTML);
  btnRegen.addEventListener('click', () => {
    // ë³€ê²½ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ë‹¤ì‹œ ìŠ¬ë¼ì´ìŠ¤/ìƒì„±
    generateHTML();
  });

  btnPreview.addEventListener('click', ()=> alert('ë¯¸ë¦¬ë³´ê¸°ê°€ ì•„ë˜ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.'));
  btnCopy.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(codeTA.value); btnCopy.textContent="ë³µì‚¬ë¨"; setTimeout(()=>btnCopy.textContent="ì½”ë“œ ë³µì‚¬",1200); }
    catch{ codeTA.select(); document.execCommand("copy"); btnCopy.textContent="ë³µì‚¬ë¨"; setTimeout(()=>btnCopy.textContent="ì½”ë“œ ë³µì‚¬",1200); }
  });

  // ===== ìƒíƒœ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
  // ì´ë¯¸ì§€ ì „ì²´ dataURL ì¶”ì¶œ(ì €ì¥ìš©)
  function imageToDataURL(){
    const c=document.createElement('canvas');
    c.width=naturalW; c.height=naturalH;
    const x=c.getContext('2d'); x.drawImage(image,0,0);
    return c.toDataURL('image/png'); // ì›ë³¸ì´ JPEGì—¬ë„ PNGë¡œ ì €ì¥(ë¬´ì†ì‹¤)
  }

  function buildState(){
    return {
      version: 1,
      savedAt: new Date().toISOString(),
      image: imageToDataURL(),             // dataURL
      naturalWidth: naturalW,
      naturalHeight: naturalH,
      lines: lines.map(l=>({ type:l.type, perc:l.perc })), // 0~1
      links: segLinks.slice()
    };
  }

  function downloadJSON(obj, filename){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = filename || 'link-slicer-state.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  btnSaveState.addEventListener('click', () => {
    if (!image.src){ alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.'); return; }
    downloadJSON(buildState(), `link-slicer-state-${Date.now()}.json`);
  });

  btnLoadState.addEventListener('click', ()=> stateFile.click());
  stateFile.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{
      const text = await f.text();
      const state = JSON.parse(text);
      await restoreState(state);
      alert('ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    }catch(err){
      console.error(err);
      alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
    }finally{
      stateFile.value = "";
    }
  });

  async function restoreState(state){
    if (!state || !state.image) throw new Error('Invalid state');
    // ì´ë¯¸ì§€ ë¡œë“œ
    await new Promise((resolve,reject)=>{
      image.onload = ()=>{ naturalW=image.naturalWidth; naturalH=image.naturalHeight; stage.style.display='inline-block'; syncOverlaySize(); resolve(); };
      image.onerror = reject;
      image.src = state.image;
    });

    // ì„ /ë§í¬ ë³µì›
    clearLines(); // ê¸°ì¡´ ì œê±°
    state.lines?.forEach(l => createLine(l.type, Math.max(0, Math.min(1, Number(l.perc)||0))));
    segLinks = Array.isArray(state.links) ? state.links.slice() : [];
    updateSegmentsUI(true);
    layoutLines();
    scheduleThumbs();

    // ì½”ë“œ/í”„ë¦¬ë·° ì´ˆê¸°í™”
    codeTA.value = "";
    preview.innerHTML = "";
    btnGen.disabled = false; btnRegen.disabled = true; btnCopy.disabled = true; btnPreview.disabled = true;
    dirty = true; lastGeneratedHTML = "";
  }

  // ì´ˆê¸° ìƒíƒœ
  btnGen.disabled=true; btnRegen.disabled=true; btnPreview.disabled=true; btnCopy.disabled=true;
})();
</script>
</body>
</html>
