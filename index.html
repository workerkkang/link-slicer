<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Link Slicer â€“ Outlook Email Ready</title>
<style>
  :root{ --border:#cfd4dc; --muted:#6b7280; --accent:#ff4d4f; --bg:#f7f9fc; --panel:#ffffff; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; display:flex; min-height:100vh; font-family:system-ui,Segoe UI,Roboto,"Apple SD Gothic Neo",Pretendard,sans-serif; background:var(--bg); color:#111827; }

  #sidebar{ width:300px; border-right:1px solid var(--border); background:var(--panel); display:flex; flex-direction:column; }
  .side-header{padding:18px 16px; border-bottom:1px solid var(--border)}
  .side-header h2{margin:0;font-size:18px}
  .side-body{padding:16px; overflow:auto}
  .muted{color:var(--muted)}
  footer{padding:10px 12px; border-top:1px solid var(--border); background:#fff; font-size:12px;color:#6b7280}

  #dropzone{ margin-top:12px; border:2px dashed #9ca3af; border-radius:12px; background:#fafafa;
    padding:18px; text-align:center; cursor:pointer; transition:all .15s ease; }
  #dropzone.dragover{ border-color:var(--accent); background:#fff1f1 }
  #fileInput{ display:none }

  #main{ flex:1; display:flex; flex-direction:column; min-width:0; }
  #topbar{ padding:12px; border-bottom:1px solid var(--border); background:#fff; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  #topbar button{ appearance:none; border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
  #topbar button.primary{ border-color:#dbe3ff; background:#eef3ff }
  #topbar .spacer{ flex:1 }
  .pill{font-size:12px;color:#4b5563}
  .segmode,.uniform,.options,.email{display:flex; align-items:center; gap:10px; border:1px solid var(--border); padding:6px 10px; border-radius:10px; background:#fafafa; }
  .uniform input,.options input[type="number"], .email input[type="text"]{ width:64px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; }
  .email input[type="text"]{ width:280px; }
  .hint{font-size:12px; color:#6b7280}

  #workarea{ display:grid; grid-template-columns:1fr 420px; gap:14px; padding:14px; min-height:0; flex:1; overflow:hidden; }

  #canvas-container{ position:relative; overflow:auto; background:#e5e7eb; border:1px solid var(--border); border-radius:10px;
    display:flex; align-items:flex-start; justify-content:center; padding:18px; min-height:0; }

  #stage{ position:relative; display:none; }
  #uploadedImage{ display:block; max-width:100%; height:auto; border:1px solid var(--border); background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.05); }
  #overlay{ position:absolute; left:0; top:0; z-index:10; pointer-events:auto; }

  .line{ position:absolute; background:var(--accent); cursor:move; box-shadow:0 0 6px rgba(255,77,79,.35); pointer-events:auto; }
  .h-line{ left:0; right:0; }
  .v-line{ top:0;  bottom:0; }

  #rightpanel{ background:#fff; border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; min-height:0; }
  #rightpanel header{ padding:12px 12px; border-bottom:1px solid var(--border); font-weight:600 }
  #segments{ padding:12px; overflow:auto; display:flex; flex-direction:column; gap:10px; min-height:0; }

  .segrow{ display:grid; grid-template-columns:76px 1fr; gap:10px; align-items:center; border:1px solid var(--border);
    padding:8px; border-radius:10px; background:#fafafa; }
  .thumb{ width:76px; height:auto; border:1px solid var(--border); border-radius:6px; display:block; background:#fff; }
  .segmeta{ font-size:12px; color:#6b7280; margin-top:4px }
  .segrow input{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; }

  #codebox{ padding:12px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:8px; }
  #code{ width:100%; min-height:160px; border:1px solid var(--border); border-radius:8px; padding:10px; font-family:ui-monospace,Consolas,monospace; }

  /* í˜ì´ì§€ ë‚´ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¹€(ìƒˆ íƒ­ë§Œ ì‚¬ìš©) */
  #previewwrap{ display:none; }

  #stateFile{ display:none }

  @media (max-width: 1160px){ #workarea{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<aside id="sidebar">
  <div class="side-header"><h2>ğŸ“Œ ì‚¬ìš©ë²• ìš”ì•½</h2></div>
  <div class="side-body">
    <ol style="margin:0;padding-left:20px">
      <li>ì´ë¯¸ì§€ ì—…ë¡œë“œ(ì•„ë˜ ë°•ìŠ¤ì— <b>ë“œë˜ê·¸&ë“œë¡­</b> ë˜ëŠ” í´ë¦­)</li>
      <li>ì¡°ê° ê¸°ì¤€ì— ë”°ë¼ ì„  ì¶”ê°€<br>
        â€¢ ê°€ë¡œ: <b>Ctrl+í´ë¦­</b>=ê°€ë¡œì„  ì¶”ê°€<br>
        â€¢ ì„¸ë¡œ: <b>Ctrl+í´ë¦­</b>=ì„¸ë¡œì„  ì¶”ê°€<br>
        â€¢ ê°€ë¡œÃ—ì„¸ë¡œ: <b>Ctrl+í´ë¦­</b>=ê°€ë¡œ, <b>Ctrl+Shift+í´ë¦­</b>=ì„¸ë¡œ</li>
      <li>Alt+í´ë¦­=ê°€ê¹Œìš´(í‘œì‹œì¤‘ì¸) ì„  ì‚­ì œ, ë“œë˜ê·¸=ì´ë™</li>
      <li>í–‰/ì—´ ì…ë ¥ í›„ â€œê· ë“±ë¶„í•  ì ìš©â€</li>
      <li>ìš°ì¸¡ ë§í¬ ì…ë ¥ â†’ HTML ìƒì„±/ë³µì‚¬</li>
    </ol>
    <div id="dropzone">
      <div style="font-weight:600; margin-bottom:4px;">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
      <div class="muted">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
      <div style="font-size:12px;color:#9ca3af;margin-top:6px;">(PNG Â· JPG Â· GIF)</div>
      <input id="fileInput" type="file" accept="image/*">
    </div>
  </div>
  <footer>ë¼ì¸/ë§í¬/ì„¸ê·¸ë¨¼íŠ¸ê°€ ëª¨ë“œë³„ë¡œ ë…ë¦½ ë™ì‘í•©ë‹ˆë‹¤.</footer>
</aside>

<main id="main">
  <div id="topbar">
    <button id="btnGen" class="primary" disabled>HTML ìƒì„±</button>
    <button id="btnRegen" disabled>HTML ì¬ìƒì„±</button>
    <button id="btnCopy" disabled>ì½”ë“œ ë³µì‚¬</button>
    <span class="spacer"></span>

    <div class="segmode" title="ì¡°ê° ê¸°ì¤€">
      ì¡°ê° ê¸°ì¤€:
      <label><input type="radio" name="mode" value="h" checked> ê°€ë¡œ</label>
      <label><input type="radio" name="mode" value="v"> ì„¸ë¡œ</label>
      <label><input type="radio" name="mode" value="grid"> ê°€ë¡œxì„¸ë¡œ</label>
    </div>

    <div class="uniform" title="ê· ë“± ê°„ê²© ìë™ ë¶„í• ">
      Row(í–‰): <input id="rowsInput" type="number" min="1" value="3">
      Col(ì—´): <input id="colsInput" type="number" min="1" value="3">
      <button id="btnUniform">ê· ë“±ë¶„í•  ì ìš©</button>
      <div class="hint">ê°€ë¡œ: Rowë§Œ, ì„¸ë¡œ: Colë§Œ ì‚¬ìš©</div>
    </div>

    <div class="options" title="ìŠ¤ëƒ…/ì ê¸ˆ/ì„  ìŠ¤íƒ€ì¼">
      <label><input id="lockToggle" type="checkbox"> ì„  ì ê¸ˆ</label>
      <label><input id="snapToggle" type="checkbox" checked> ìŠ¤ëƒ…</label>
      ìŠ¤ëƒ…(px): <input id="snapTol" type="number" min="0" value="8">
      ìƒ‰ìƒ: <input id="lineColor" type="color" value="#ff4d4f">
      ë‘ê»˜(px): <input id="lineThickness" type="number" min="1" value="2">
    </div>

    <div class="email" title="Outlook í˜¸í™˜ ì´ë©”ì¼ ëª¨ë“œ">
      <label><input id="emailMode" type="checkbox"> ì´ë©”ì¼ ëª¨ë“œ(Outlook)</label>
      <label>
        ì°¸ì¡° ë°©ì‹:
        <select id="emailImgRef">
          <option value="url" selected>URL</option>
          <option value="cid">CID(ì²¨ë¶€)</option>
        </select>
      </label>
      <label id="baseLabel">ì´ë¯¸ì§€ URL ì ‘ë‘ì–´:
        <input id="emailBase" type="text" placeholder="https://cdn.example.com/newsletter">
      </label>
      <div class="hint">ì´ë©”ì¼ ëª¨ë“œ: data:URL ë¯¸ì‚¬ìš©. URL ë˜ëŠ” CIDë¡œë§Œ ì‚½ì…</div>
    </div>

    <span class="spacer"></span>
    <button id="btnSaveState" title="í˜„ì¬ ì‘ì—… ì €ì¥(JSON ë‹¤ìš´ë¡œë“œ)">ìƒíƒœ ì €ì¥</button>
    <button id="btnLoadState" title="ì €ì¥í•œ JSON ë¶ˆëŸ¬ì˜¤ê¸°">ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <input id="stateFile" type="file" accept="application/json" />
    <button id="btnClearLines">ì„  ëª¨ë‘ ì‚­ì œ</button>
    <span class="pill">Alt ì‚­ì œëŠ” â€œí‘œì‹œì¤‘ì¸â€ ì„ ë§Œ ëŒ€ìƒ</span>
  </div>

  <div id="workarea">
    <div id="canvas-container">
      <div id="stage">
        <img id="uploadedImage" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€">
        <div id="overlay"></div>
      </div>
    </div>

    <div id="rightpanel">
      <header>ì¡°ê° ë§í¬ ì…ë ¥ + ì¸ë„¤ì¼</header>
      <div id="segments"></div>
      <div id="codebox">
        <button id="btnPreview" disabled>ë¯¸ë¦¬ë³´ê¸° ìƒì„±</button>
        <textarea id="code" placeholder="HTML ìƒì„± í›„ ì½”ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤" readonly></textarea>
      </div>
    </div>
  </div>
</main>

<script>
(() => {
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const stateFile = document.getElementById('stateFile');

  const stage = document.getElementById('stage');
  const overlay = document.getElementById('overlay');
  const image = document.getElementById('uploadedImage');

  const segmentsWrap = document.getElementById('segments');
  const btnGen = document.getElementById('btnGen');
  const btnRegen = document.getElementById('btnRegen');
  const btnCopy = document.getElementById('btnCopy');
  const btnClearLines = document.getElementById('btnClearLines');
  const btnPreview = document.getElementById('btnPreview');
  const btnSaveState = document.getElementById('btnSaveState');
  const btnLoadState = document.getElementById('btnLoadState');
  const codeTA = document.getElementById('code');

  const modeRadios = document.querySelectorAll('input[name="mode"]');
  const rowsInput = document.getElementById('rowsInput');
  const colsInput = document.getElementById('colsInput');
  const btnUniform = document.getElementById('btnUniform');

  const lockToggle = document.getElementById('lockToggle');
  const snapToggle = document.getElementById('snapToggle');
  const snapTol = document.getElementById('snapTol');
  const lineColor = document.getElementById('lineColor');
  const lineThickness = document.getElementById('lineThickness');

  const emailMode = document.getElementById('emailMode');
  const emailImgRef = document.getElementById('emailImgRef');
  const emailBase = document.getElementById('emailBase');
  const baseLabel = document.getElementById('baseLabel');

  let lines = []; // { type:'h'|'v', perc:0..1, el, origin:'h'|'v'|'grid' }
  let naturalW = 0, naturalH = 0;

  let linkStore = { h: [], v: [], grid: [] };

  let thumbRAF = null;
  let segMode = 'h';
  let uniformRows = 3, uniformCols = 3;

  let styleColor = '#ff4d4f';
  let styleThickness = 2;
  let locked = false;
  let snapEnabled = true;
  let snapPx = 8;
  let isDragging = false;

  function displaySize(){ return { w: overlay.clientWidth, h: overlay.clientHeight }; }
  function syncOverlaySize(){ overlay.style.width=image.clientWidth+'px'; overlay.style.height=image.clientHeight+'px'; }
  function isVisibleByMode(l){ return l.origin === segMode; }

  function applyStyle(el, type){
    el.style.background = styleColor;
    if(type==='h'){ el.style.height = styleThickness + 'px'; el.className='line h-line'; }
    else          { el.style.width  = styleThickness + 'px'; el.className='line v-line'; }
    el.style.boxShadow = `0 0 6px ${styleColor}55`;
  }

  function layoutLines(){
    const {w,h} = displaySize();
    lines.forEach(l=>{
      if(l.type==='h'){
        l.el.style.left='0'; l.el.style.right='0';
        l.el.style.top=(l.perc*h - styleThickness/2) + 'px';
      }else{
        l.el.style.top='0'; l.el.style.bottom='0';
        l.el.style.left=(l.perc*w - styleThickness/2) + 'px';
      }
      applyStyle(l.el, l.type);
      const visible = isVisibleByMode(l);
      l.el.style.display = visible ? '' : 'none';
      l.el.style.cursor = visible ? (locked ? 'default' : 'move') : 'default';
      l.el.style.pointerEvents = (visible && !locked) ? 'auto' : 'none';
    });
  }

  function getPercsSorted(type){
    return lines
      .filter(l=>l.origin===segMode && l.type===type)
      .map(l=>l.perc)
      .sort((a,b)=>a-b);
  }

  function markDirty(){
    btnRegen.disabled = false;
    btnPreview.disabled = true;
    btnCopy.disabled = true;
    codeTA.value = '';
  }

  function loadFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    image.onload = () => {
      naturalW = image.naturalWidth; naturalH = image.naturalHeight;
      stage.style.display='inline-block';
      syncOverlaySize(); fullReset();
    };
    image.src=url;
  }

  dropzone.addEventListener('click', ()=>fileInput.click());
  fileInput.addEventListener('change', e=>loadFile(e.target.files?.[0]));
  ['dragenter','dragover'].forEach(t=>dropzone.addEventListener(t, e=>{e.preventDefault(); dropzone.classList.add('dragover');}));
  ['dragleave','dragend','drop'].forEach(t=>dropzone.addEventListener(t, ()=>dropzone.classList.remove('dragover')));
  dropzone.addEventListener('drop', e=>{ e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f?.type.startsWith('image/')) loadFile(f); });

  function pointerInOverlay(ev){
    const r = overlay.getBoundingClientRect();
    const x = ev.clientX - r.left, y = ev.clientY - r.top;
    const w = overlay.clientWidth, h = overlay.clientHeight;
    return {x,y,w,h, inside:x>=0&&y>=0&&x<=w&&y<=h};
  }

  function createLine(type, perc, origin){
    const el = document.createElement('div');
    overlay.appendChild(el);
    const obj = {type, perc: Math.max(0, Math.min(1, perc)), el, origin};
    lines.push(obj);
    applyStyle(el, type);
    layoutLines();
    updateSegmentsUI(true);
    markDirty();

    let startClient=0, startPerc=obj.perc;

    el.addEventListener('click', (e)=> e.stopPropagation());

    el.addEventListener('mousedown', (e)=>{
      if(locked || !isVisibleByMode(obj)) return;
      if(e.button !== 0) return;
      e.preventDefault();
      e.stopPropagation();
      isDragging = true;

      startClient=(type==='h')?e.clientY:e.clientX; startPerc=obj.perc;

      const onMove=(ev)=>{
        const {w,h}=displaySize();
        const d=(type==='h')? (ev.clientY-startClient)/h : (ev.clientX-startClient)/w;
        let next = Math.max(0, Math.min(1, startPerc+d));

        if(snapEnabled){
          const pxTol = snapPx;
          const currPx = (type==='h') ? next*h : next*w;
          let snapTargets = [0, (type==='h')?h:w];
          lines.forEach(l=>{
            if(l!==obj && l.type===type && l.origin===segMode) {
              snapTargets.push((type==='h')? l.perc*h : l.perc*w);
            }
          });
          let best = currPx, bestDist = Infinity;
          for(const t of snapTargets){
            const dist = Math.abs(currPx - t);
            if(dist <= pxTol && dist < bestDist){ best = t; bestDist = dist; }
          }
          if(bestDist !== Infinity){ next = (type==='h') ? best/h : best/w; }
        }

        obj.perc = next;
        layoutLines();
        scheduleThumbs();
        markDirty();
      };

      const onUp=()=>{
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        updateSegmentsUI(false);
        setTimeout(()=>{ isDragging = false; }, 0);
      };

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  }

  function deleteNearest(x,y){
    const {w,h}=displaySize();
    let nearest=null, dist=Infinity;
    lines.forEach(l=>{
      if(l.origin!==segMode) return;
      const d=(l.type==='h')?Math.abs(l.perc*h-y):Math.abs(l.perc*w-x);
      if(d<dist){dist=d; nearest=l;}
    });
    if(nearest){
      nearest.el.remove();
      lines = lines.filter(l=>l!==nearest);
      updateSegmentsUI(true);
      markDirty();
    }
  }

  // ë¼ì¸ ìƒì„±: Ctrl(+Shift)+í´ë¦­ (ë“œë˜ê·¸ ì¤‘ í´ë¦­ ë°©ì§€)
  overlay.addEventListener('click', e=>{
    if(!image.src) return;
    if(e.button !== 0) return;
    if(isDragging) return;
    const p=pointerInOverlay(e); if(!p.inside) return;

    if(e.altKey){ deleteNearest(p.x,p.y); return; }
    if(!e.ctrlKey) return;

    if(segMode==='h'){ createLine('h', p.y/p.h, 'h'); return; }
    if(segMode==='v'){ createLine('v', p.x/p.w, 'v'); return; }
    const addType = e.shiftKey ? 'v' : 'h';
    if(addType==='h') createLine('h', p.y/p.h, 'grid'); else createLine('v', p.x/p.w, 'grid');
  });

  function ensureLinkStoreSize(len){
    const arr = linkStore[segMode];
    if(arr.length < len){ for(let i=arr.length;i<len;i++) arr.push(""); }
    else if(arr.length > len){ arr.length = len; }
  }

  modeRadios.forEach(r=>r.addEventListener('change', ()=>{
    segMode = [...modeRadios].find(x=>x.checked).value;
    layoutLines();
    updateSegmentsUI(true);
    markDirty();
  }));

  function rebuildUniformForMode(rows, cols){
    if(segMode==='h'){
      lines.filter(l=>l.origin==='h' && l.type==='h').forEach(l=>l.el.remove());
      lines = lines.filter(l=>!(l.origin==='h' && l.type==='h'));
      const count = Math.max(1, rows|0);
      for(let i=1;i<=count-1;i++) createLine('h', i/count, 'h');
    }else if(segMode==='v'){
      lines.filter(l=>l.origin==='v' && l.type==='v').forEach(l=>l.el.remove());
      lines = lines.filter(l=>!(l.origin==='v' && l.type==='v'));
      const count = Math.max(1, cols|0);
      for(let i=1;i<=count-1;i++) createLine('v', i/count, 'v');
    }else{
      lines.filter(l=>l.origin==='grid').forEach(l=>l.el.remove());
      lines = lines.filter(l=>!(l.origin==='grid'));
      const rCnt = Math.max(1, rows|0), cCnt = Math.max(1, cols|0);
      for(let i=1;i<=rCnt-1;i++) createLine('h', i/rCnt, 'grid');
      for(let j=1;j<=cCnt-1;j++) createLine('v', j/cCnt, 'grid');
    }
    layoutLines();
    updateSegmentsUI(true);
    scheduleThumbs(); markDirty();
  }

  btnUniform.addEventListener('click', ()=>{
    const rows = Math.max(1, parseInt(rowsInput.value||'1',10));
    const cols = Math.max(1, parseInt(colsInput.value||'1',10));
    uniformRows = rows; uniformCols = cols;
    rebuildUniformForMode(rows, cols);
  });

  lockToggle.addEventListener('change', ()=>{ locked = lockToggle.checked; layoutLines(); });
  snapToggle.addEventListener('change', ()=>{ snapEnabled = snapToggle.checked; });
  snapTol.addEventListener('input', ()=>{ snapPx = Math.max(0, parseInt(snapTol.value||'0',10)); });
  lineColor.addEventListener('input', ()=>{ styleColor = lineColor.value || '#ff4d4f'; layoutLines(); });
  lineThickness.addEventListener('input', ()=>{ styleThickness = Math.max(1, parseInt(lineThickness.value||'2',10)); layoutLines(); });

  emailImgRef.addEventListener('change', ()=>{
    baseLabel.style.display = (emailImgRef.value==='url') ? '' : 'none';
  });
  baseLabel.style.display = (emailImgRef.value==='url') ? '' : 'none';

  const ro=new ResizeObserver(()=>{ syncOverlaySize(); layoutLines(); scheduleThumbs(); });
  ro.observe(image); ro.observe(stage);

  btnClearLines.addEventListener('click', ()=>{
    lines.filter(l=>l.origin===segMode).forEach(l=>l.el.remove());
    lines = lines.filter(l=>l.origin!==segMode);
    updateSegmentsUI(true);
    markDirty();
  });

  function scheduleThumbs(){ if(thumbRAF) cancelAnimationFrame(thumbRAF); thumbRAF=requestAnimationFrame(renderThumbnails); }

  function updateSegmentsUI(regenThumbs){
    let rows=1, cols=1, hCuts=[], vCuts=[];
    if(segMode==='h'){ hCuts=getPercsSorted('h'); rows=hCuts.length+1; cols=1; }
    else if(segMode==='v'){ vCuts=getPercsSorted('v'); rows=1; cols=vCuts.length+1; }
    else{ hCuts=getPercsSorted('h'); vCuts=getPercsSorted('v'); rows=hCuts.length+1; cols=vCuts.length+1; }

    const total = rows*cols;
    ensureLinkStoreSize(total);

    segmentsWrap.innerHTML="";
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const idx = r*cols + c;
        const row = document.createElement('div');
        row.className='segrow'; row.dataset.idx=idx;

        const left = document.createElement('div');
        const img  = document.createElement('img'); img.className='thumb'; img.alt=`seg-${idx+1}`;
        left.appendChild(img);

        const meta = document.createElement('div'); meta.className='segmeta';
        if(segMode==='h') meta.textContent = `ì¡°ê° ${idx+1} Â· í–‰ ${r+1}/${rows}`;
        else if(segMode==='v') meta.textContent = `ì¡°ê° ${idx+1} Â· ì—´ ${c+1}/${cols}`;
        else meta.textContent = `ì¡°ê° ${idx+1} Â· (${r+1}, ${c+1}) / ${rows}Ã—${cols}`;
        left.appendChild(meta);

        const input = document.createElement('input');
        input.type='url'; input.placeholder='https:// ë§í¬ ì…ë ¥'; input.value=linkStore[segMode][idx] || "";
        input.addEventListener('input', ev=>{
          linkStore[segMode][idx] = ev.target.value.trim();
          markDirty();
        });

        row.appendChild(left); row.appendChild(input);
        segmentsWrap.appendChild(row);
      }
    }

    btnGen.disabled = !image.src;
    btnPreview.disabled=true; btnCopy.disabled=true; codeTA.value='';
    if(regenThumbs) scheduleThumbs();
  }

  function renderThumbnails(){
    thumbRAF=null; if(!image.src) return;

    const hPerc=[0,...getPercsSorted('h'),1];
    const vPerc=[0,...getPercsSorted('v'),1];

    const ys=hPerc.map(p=>Math.round(p*naturalH));
    const xs=vPerc.map(p=>Math.round(p*naturalW));

    const c=document.createElement('canvas'); const ctx=c.getContext('2d');

    if(segMode==='h'){
      let idx=0;
      for(let r=0;r<ys.length-1;r++){
        const top=ys[r], h=ys[r+1]-ys[r];
        const W=76, H=Math.max(1, Math.round(h*(W/naturalW)));
        c.width=W; c.height=H; ctx.clearRect(0,0,W,H);
        ctx.drawImage(image, 0, top, naturalW, h, 0, 0, W, H);
        const url=c.toDataURL('image/png');
        const imgEl=segmentsWrap.querySelector(`.segrow[data-idx="${idx}"] img.thumb`);
        if(imgEl){ imgEl.src=url; imgEl.style.width=W+'px'; }
        idx++;
      }
      return;
    }

    if(segMode==='v'){
      let idx=0;
      for(let ci=0;ci<xs.length-1;ci++){
        const left=xs[ci], w=xs[ci+1]-xs[ci];
        const H=76, W=Math.max(1, Math.round(w*(H/naturalH)));
        c.width=W; c.height=H; ctx.clearRect(0,0,W,H);
        ctx.drawImage(image, left, 0, w, naturalH, 0, 0, W, H);
        const url=c.toDataURL('image/png');
        const imgEl=segmentsWrap.querySelector(`.segrow[data-idx="${idx}"] img.thumb`);
        if(imgEl){ imgEl.src=url; imgEl.style.width=W+'px'; }
        idx++;
      }
      return;
    }

    // grid
    let idx=0;
    for(let r=0;r<ys.length-1;r++){
      for(let ci=0;ci<xs.length-1;ci++){
        const top=ys[r], h=ys[r+1]-ys[r];
        const left=xs[ci], w=xs[ci+1]-xs[ci];
        if(w<=0||h<=0){ idx++; continue; }
        const box=76, scale=Math.min(box/w, box/h);
        const W=Math.max(1, Math.round(w*scale));
        const H=Math.max(1, Math.round(h*scale));
        c.width=W; c.height=H; ctx.clearRect(0,0,W,H);
        ctx.drawImage(image, left, top, w, h, 0, 0, W, H);
        const url=c.toDataURL('image/png');
        const imgEl=segmentsWrap.querySelector(`.segrow[data-idx="${idx}"] img.thumb`);
        if(imgEl){ imgEl.src=url; imgEl.style.width=W+'px'; }
        idx++;
      }
    }
  }

  // ì¡°ê° PNGë¥¼ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ(ì´ë©”ì¼ ëª¨ë“œ URL ë°©ì‹ ë³´ì¡°)
  function downloadSlices(blobs, names){
    blobs.forEach((blob, i)=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=names[i];
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    });
  }

  // === HTML ìƒì„± === (Outlook ëŒ€ì‘: ì „ë¶€ table ê¸°ë°˜)
  function generateHTML(){
    if(!image.src) return;

    const hPerc=[0,...getPercsSorted('h'),1];
    const vPerc=[0,...getPercsSorted('v'),1];
    const ys=hPerc.map(p=>Math.round(p*naturalH));
    const xs=vPerc.map(p=>Math.round(p*naturalW));

    const canv=document.createElement('canvas');
    const ctx=canv.getContext('2d');
    const currentLinks = linkStore[segMode];

    const wantEmail = emailMode.checked;
    const refType = emailImgRef.value; // 'url' | 'cid'
    const base = (emailBase.value||'').replace(/\/+$/,''); // trim tail slash
    const blobs = [];
    const fnames = [];

    function imgSrcFrom(dataUrl, fileName){
      if(!wantEmail){
        return dataUrl; // ì¼ë°˜ ëª¨ë“œ: data URL ì‚¬ìš©
      }
      if(refType==='url'){
        return base ? `${base}/${fileName}` : fileName; // ì ‘ë‘ì–´ ì—†ìœ¼ë©´ íŒŒì¼ëª…ë§Œ(í›„ì† í˜¸ìŠ¤íŒ…/ì²¨ë¶€ ì‹œ ìˆ˜ì • ê°€ëŠ¥)
      }
      // CID
      return `cid:${fileName}`;
    }

    function pushBlob(dataUrl, fileName){
      if(wantEmail){
        const arr = dataUrl.split(',');
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8 = new Uint8Array(n);
        while(n--){ u8[n] = bstr.charCodeAt(n); }
        blobs.push(new Blob([u8], {type:'image/png'}));
        fnames.push(fileName);
      }
    }

    // ê°€ë¡œ ëª¨ë“œ: 1ì—´ ní–‰ í…Œì´ë¸”
    if(segMode==='h'){
      canv.width=naturalW;
      const rowsHtml=[];
      for(let r=0;r<ys.length-1;r++){
        const top=ys[r], h=ys[r+1]-ys[r];
        canv.height=h; ctx.clearRect(0,0,canv.width,canv.height);
        ctx.drawImage(image, 0, top, naturalW, h, 0, 0, naturalW, h);
        const dataUrl=canv.toDataURL('image/png');
        const fname=`slice-h-${r+1}.png`;
        const src=imgSrcFrom(dataUrl, fname);
        pushBlob(dataUrl, fname);

        const href=(currentLinks[r]||"").trim();
        const imgTag=`<img src="${src}" alt="slice-${r+1}" width="800" style="display:block;border:0;width:100%;height:auto;" />`;
        const inner = href ? `<a href="${href}" target="_blank" style="text-decoration:none;">${imgTag}</a>` : imgTag;
        rowsHtml.push(`<tr><td style="padding:0;border:none;">${inner}</td></tr>`);
      }
      const table = `<table role="presentation" cellspacing="0" cellpadding="0" border="0" style="border-collapse:collapse;border-spacing:0;width:100%;">\n${rowsHtml.join("\n")}\n</table>`;
      codeTA.value = `<!-- Generated by Link Slicer (h) Outlook-safe -->\n<div style="max-width:800px;margin:0 auto;">\n${table}\n</div>`;
      btnPreview.disabled=false; btnCopy.disabled=false; btnRegen.disabled=false;
      if(wantEmail && refType==='url'){ downloadSlices(blobs, fnames); }
      return;
    }

    // ì„¸ë¡œ ëª¨ë“œ: 1í–‰ nì—´ í…Œì´ë¸”(ì—´ ë„ˆë¹„ % ì§€ì •, img width ì†ì„± ë¶€ì—¬)
    if(segMode==='v'){
      canv.height=naturalH;
      const tds=[];
      for(let ci=0;ci<xs.length-1;ci++){
        const left=xs[ci], w=xs[ci+1]-xs[ci];
        canv.width=w; ctx.clearRect(0,0,canv.width,canv.height);
        ctx.drawImage(image, left, 0, w, naturalH, 0, 0, w, naturalH);
        const dataUrl=canv.toDataURL('image/png');
        const fname=`slice-v-${ci+1}.png`;
        const src=imgSrcFrom(dataUrl, fname);
        pushBlob(dataUrl, fname);

        const href=(currentLinks[ci]||"").trim();
        const pct = (w / naturalW * 100).toFixed(6);
        // Outlook í˜¸í™˜: td width, img width ë‘˜ ë‹¤ ì§€ì •
        const imgTag=`<img src="${src}" alt="slice-${ci+1}" width="${Math.round(800 * (w/naturalW))}" style="display:block;border:0;width:100%;height:auto;" />`;
        const inner = href ? `<a href="${href}" target="_blank" style="text-decoration:none;">${imgTag}</a>` : imgTag;
        tds.push(`<td width="${pct}%" style="padding:0;border:none;width:${pct}%;vertical-align:top;">${inner}</td>`);
      }
      const table = `<table role="presentation" cellspacing="0" cellpadding="0" border="0" style="border-collapse:collapse;border-spacing:0;width:100%;"><tr>\n${tds.join("\n")}\n</tr></table>`;
      codeTA.value = `<!-- Generated by Link Slicer (v) Outlook-safe -->\n<div style="max-width:800px;margin:0 auto;">\n${table}\n</div>`;
      btnPreview.disabled=false; btnCopy.disabled=false; btnRegen.disabled=false;
      if(wantEmail && refType==='url'){ downloadSlices(blobs, fnames); }
      return;
    }

    // ê·¸ë¦¬ë“œ ëª¨ë“œ: rÃ—c í…Œì´ë¸”(ì—´ ë„ˆë¹„ % ì§€ì •)
    if(segMode==='grid'){
      const rows = ys.length-1, cols = xs.length-1;
      const rowsHtml=[];
      for(let r=0;r<rows;r++){
        const tds=[];
        for(let c=0;c<cols;c++){
          const top=ys[r], h=ys[r+1]-ys[r];
          const left=xs[c], w=xs[c+1]-xs[c];
          canv.width=w; canv.height=h; ctx.clearRect(0,0,w,h);
          ctx.drawImage(image, left, top, w, h, 0, 0, w, h);
          const dataUrl=canv.toDataURL('image/png');
          const flatIndex = r*cols + c;
          const fname=`slice-grid-${r+1}-${c+1}.png`;
          const src=imgSrcFrom(dataUrl, fname);
          pushBlob(dataUrl, fname);

          const href=(currentLinks[flatIndex]||"").trim();
          const pct = (w / naturalW * 100).toFixed(6);
          const imgTag=`<img src="${src}" alt="cell-${r+1}-${c+1}" width="${Math.round(800 * (w/naturalW))}" style="display:block;border:0;width:100%;height:auto;" />`;
          const inner = href ? `<a href="${href}" target="_blank" style="text-decoration:none;">${imgTag}</a>` : imgTag;
          tds.push(`<td width="${pct}%" style="padding:0;border:none;width:${pct}%;vertical-align:top;">${inner}</td>`);
        }
        rowsHtml.push(`<tr>${tds.join("")}</tr>`);
      }
      const table = `<table role="presentation" cellspacing="0" cellpadding="0" border="0" style="border-collapse:collapse;border-spacing:0;width:100%;">\n${rowsHtml.join("\n")}\n</table>`;
      codeTA.value = `<!-- Generated by Link Slicer (grid) Outlook-safe -->\n<div style="max-width:800px;margin:0 auto;">\n${table}\n</div>`;
      btnPreview.disabled=false; btnCopy.disabled=false; btnRegen.disabled=false;
      if(wantEmail && refType==='url'){ downloadSlices(blobs, fnames); }
      return;
    }
  }

  btnGen.addEventListener('click', generateHTML);
  btnRegen.addEventListener('click', generateHTML);

  btnPreview.addEventListener('click', () => {
    if (!codeTA.value.trim()) {
      alert('HTMLì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
      return;
    }
    const win = window.open('', '_blank');
    if (!win) { alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.'); return; }

    const htmlDoc = `
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Link Slicer Preview (${segMode})</title>
<style>
body { margin:0; padding:20px; font-family:system-ui, sans-serif; background:#fafafa; }
a { text-decoration:none; }
img { display:block; max-width:100%; height:auto; margin:0 auto; border:none; }
.container { max-width:800px; margin:0 auto; }
.notice { font-size:13px; color:#888; text-align:center; margin-bottom:10px; }
</style>
</head>
<body>
<div class="notice">ë¯¸ë¦¬ë³´ê¸° â€“ ì´ë©”ì¼ ëª¨ë“œì—ì„œ ì´ë¯¸ì§€ URL ë˜ëŠ” CIDë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
<div class="container">
${codeTA.value
  .replace(/<!--[\s\S]*?-->/g, '')
  .replace(/^<div[^>]*>|<\/div>$/g, '')
}
</div>
</body>
</html>`;
    win.document.open();
    win.document.write(htmlDoc);
    win.document.close();
  });

  btnCopy.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(codeTA.value); btnCopy.textContent="ë³µì‚¬ë¨"; setTimeout(()=>btnCopy.textContent="ì½”ë“œ ë³µì‚¬",1200); }
    catch{ codeTA.select(); document.execCommand("copy"); btnCopy.textContent="ë³µì‚¬ë¨"; setTimeout(()=>btnCopy.textContent="ì½”ë“œ ë³µì‚¬",1200); }
  });

  function imageToDataURL(){
    const c=document.createElement('canvas'); c.width=naturalW; c.height=naturalH;
    c.getContext('2d').drawImage(image,0,0); return c.toDataURL('image/png');
  }

  function buildState(){
    return {
      version: 12,
      savedAt: new Date().toISOString(),
      mode: segMode,
      rows: uniformRows,
      cols: uniformCols,
      style: { color: styleColor, thickness: styleThickness },
      options: { locked, snapEnabled, snapPx },
      image: imageToDataURL(),
      naturalWidth: naturalW,
      naturalHeight: naturalH,
      lines: lines.map(l=>({type:l.type, perc:l.perc, origin:l.origin})),
      links: linkStore
    };
  }

  function downloadJSON(obj, filename){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename||'link-slicer-state.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  btnSaveState.addEventListener('click', ()=>{
    if(!image.src){ alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.'); return; }
    downloadJSON(buildState(), `link-slicer-state-${Date.now()}.json`);
  });

  btnLoadState.addEventListener('click', ()=>stateFile.click());
  stateFile.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text=await f.text(); const state=JSON.parse(text);
      await restoreState(state); alert('ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    }catch(err){ console.error(err); alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: JSONì„ í™•ì¸í•˜ì„¸ìš”.'); }
    finally{ stateFile.value=""; }
  });

  async function restoreState(state){
    if(!state || !state.image) throw new Error('Invalid state');
    await new Promise((resolve,reject)=>{
      image.onload=()=>{ naturalW=image.naturalWidth; naturalH=image.naturalHeight; stage.style.display='inline-block'; syncOverlaySize(); resolve(); };
      image.onerror=reject; image.src=state.image;
    });

    if(['h','v','grid'].includes(state.mode)){ segMode=state.mode; document.querySelector(`input[name="mode"][value="${segMode}"]`).checked=true; }
    if(typeof state.rows==='number') { uniformRows = Math.max(1, state.rows|0); rowsInput.value = uniformRows; }
    if(typeof state.cols==='number') { uniformCols = Math.max(1, state.cols|0); colsInput.value = uniformCols; }

    if(state.style){
      styleColor = state.style.color || styleColor;
      styleThickness = Math.max(1, parseInt(state.style.thickness||styleThickness,10));
      lineColor.value = styleColor; lineThickness.value = styleThickness;
    }
    if(state.options){
      locked = !!state.options.locked; lockToggle.checked = locked;
      snapEnabled = !!state.options.snapEnabled; snapToggle.checked = snapEnabled;
      snapPx = Math.max(0, parseInt(state.options.snapPx||snapPx,10)); snapTol.value = snapPx;
    }

    lines.forEach(l=>l.el.remove()); lines=[];
    state.lines?.forEach(l=>createLine(l.type, Math.max(0,Math.min(1,Number(l.perc)||0)), l.origin==='h'?'h':l.origin==='v'?'v':'grid'));
    layoutLines();

    if(state.links && typeof state.links==='object'){
      linkStore.h  = Array.isArray(state.links.h)    ? state.links.h.slice() : [];
      linkStore.v  = Array.isArray(state.links.v)    ? state.links.v.slice() : [];
      linkStore.grid = Array.isArray(state.links.grid)? state.links.grid.slice() : [];
    }else{
      linkStore = { h:[], v:[], grid:[] };
    }

    updateSegmentsUI(true);
    scheduleThumbs();

    codeTA.value=""; 
    btnGen.disabled=false; btnRegen.disabled=true; btnCopy.disabled=true; btnPreview.disabled=true;
  }

  function clearLinesUI(){ segmentsWrap.innerHTML=''; codeTA.value=''; btnPreview.disabled=true; btnCopy.disabled=true; btnGen.disabled=!image.src; }
  function fullReset(){ lines.forEach(l=>l.el.remove()); lines=[]; linkStore={h:[],v:[],grid:[]}; clearLinesUI(); btnGen.disabled=false; btnRegen.disabled=true; btnPreview.disabled=true; btnCopy.disabled=true; }

  // ì´ˆê¸° ìƒíƒœ
  btnGen.disabled=true; btnRegen.disabled=true; btnPreview.disabled=true; btnCopy.disabled=true;
  styleColor = lineColor.value; styleThickness = parseInt(lineThickness.value,10)||2;
  locked = lockToggle.checked; snapEnabled = snapToggle.checked; snapPx = parseInt(snapTol.value,10)||8;
})();
</script>
</body>
</html>
