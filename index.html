<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Link Slicer â€“ ë¶„í• ì„  & ë§í¬ ìƒì„±ê¸°</title>
<style>
  :root{
    --border:#cfd4dc; --muted:#6b7280; --accent:#ff4d4f; --bg:#f7f9fc; --panel:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; display:flex; min-height:100vh;
    font-family:system-ui,Segoe UI,Roboto,"Apple SD Gothic Neo",Pretendard,sans-serif;
    background:var(--bg); color:#111827;
  }

  /* ì™¼ìª½: ì‚¬ìš©ë²• + ì—…ë¡œë“œ */
  #sidebar{
    width:300px; border-right:1px solid var(--border);
    background:var(--panel); display:flex; flex-direction:column;
  }
  .side-header{padding:18px 16px; border-bottom:1px solid var(--border)}
  .side-header h2{margin:0;font-size:18px}
  .side-body{padding:16px; overflow:auto}
  .muted{color:var(--muted)}
  ul{margin:8px 0 0 18px}
  footer{padding:10px 12px; border-top:1px solid var(--border); background:#fff; font-size:12px;color:#6b7280}

  /* ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ ë°•ìŠ¤ */
  #dropzone{
    margin-top:12px; border:2px dashed #9ca3af; border-radius:12px; background:#fafafa;
    padding:18px; text-align:center; cursor:pointer; transition:all .15s ease;
  }
  #dropzone.dragover{ border-color:var(--accent); background:#fff1f1 }
  #fileInput{ display:none }

  /* ê°€ìš´ë°: ì‘ì—… ì˜ì—­ */
  #main{ flex:1; display:flex; flex-direction:column; min-width:0; }
  #topbar{ padding:12px; border-bottom:1px solid var(--border); background:#fff; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  #topbar button{
    appearance:none; border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
  }
  #topbar button.primary{ border-color:#dbe3ff; background:#eef3ff }
  #topbar .pill{font-size:12px;color:#4b5563}

  #workarea{
    display:grid; grid-template-columns:1fr 340px; gap:14px;
    padding:14px; min-height:0; flex:1; overflow:hidden;
  }

  /* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ(ìŠ¤í¬ë¡¤ ì˜ì—­) */
  #canvas-container{
    position:relative; overflow:auto; background:#e5e7eb; border:1px solid var(--border); border-radius:10px;
    display:flex; align-items:flex-start; justify-content:center; padding:18px;
    min-height:0;
  }

  /* ìŠ¤í…Œì´ì§€: ì´ë¯¸ì§€ + ì˜¤ë²„ë ˆì´ ë¬¶ìŒ */
  #stage{
    position:relative; display:none;
  }
  #uploadedImage{
    display:block; max-width:100%; height:auto; border:1px solid var(--border); background:#fff;
    box-shadow:0 2px 8px rgba(0,0,0,.05);
  }

  /* ì˜¤ë²„ë ˆì´: ì´ë¯¸ì§€ ìœ„ì— ì–¹ëŠ” ë ˆì´ì–´(ì„ /íˆíŠ¸ì˜ì—­) */
  #overlay{
    position:absolute; left:0; top:0; z-index:10; pointer-events:auto; /* ì„ ë§Œ í¬ì¸í„° í—ˆìš© */
  }

  /* ì„ (ë¹¨ê°„) â€“ ì˜¤ë²„ë ˆì´ ìœ„ì— í‘œì‹œ */
  .line{
    position:absolute; background:var(--accent); cursor:move; box-shadow:0 0 6px rgba(255,77,79,.45);
    pointer-events:auto; /* ì„ ì€ ë“œë˜ê·¸ ê°€ëŠ¥ */
  }
  .h-line{ height:2px; left:0; right:0; }
  .v-line{ width:2px;  top:0;  bottom:0; }

  /* ì˜¤ë¥¸ìª½: ë§í¬ ì…ë ¥ íŒ¨ë„ */
  #rightpanel{
    background:#fff; border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; min-height:0;
  }
  #rightpanel header{ padding:12px 12px; border-bottom:1px solid var(--border); font-weight:600 }
  #segments{ padding:12px; overflow:auto; display:flex; flex-direction:column; gap:10px; min-height:0; }
  .segrow{ display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:center; }
  .segrow small{ color:#6b7280 }
  .segrow input{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; }
  #codebox{ padding:12px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:8px; }
  #code{ width:100%; min-height:120px; border:1px solid var(--border); border-radius:8px; padding:10px; font-family:ui-monospace,Consolas,monospace; }

  /* ë¯¸ë¦¬ë³´ê¸° */
  #previewwrap{ padding:12px; border-top:1px solid var(--border); }
  #preview{ display:flex; flex-direction:column; gap:4px; }

  @media (max-width: 1080px){
    #workarea{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°”: ì‚¬ìš©ë²• + ì—…ë¡œë“œ -->
<aside id="sidebar">
  <div class="side-header">
    <h2>ğŸ“Œ ì‚¬ìš©ë²• ìš”ì•½</h2>
  </div>
  <div class="side-body">
    <ol style="margin:0;padding-left:20px">
      <li>ì´ë¯¸ì§€ ì—…ë¡œë“œ(ì•„ë˜ ë°•ìŠ¤ì— <b>ë“œë˜ê·¸&ë“œë¡­</b> ë˜ëŠ” í´ë¦­)</li>
      <li>ì´ë¯¸ì§€ ìœ„ í´ë¦­:
        <ul>
          <li>ì¼ë°˜ í´ë¦­ â†’ <b>ê°€ë¡œì„ </b></li>
          <li><kbd>Shift</kbd>+í´ë¦­ â†’ <b>ì„¸ë¡œì„ </b></li>
          <li><kbd>Alt</kbd>+í´ë¦­ â†’ <b>ê°€ê¹Œìš´ ì„  ì‚­ì œ</b></li>
        </ul>
      </li>
      <li>ì„ ì„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ ì¡°ì •</li>
      <li>ìš°ì¸¡ íŒ¨ë„ì—ì„œ ê° ì¡°ê° <b>ë§í¬</b> ì…ë ¥ â†’ ìƒë‹¨ <b>HTML ìƒì„±/ë³µì‚¬</b></li>
    </ol>

    <!-- ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ -->
    <div id="dropzone">
      <div style="font-weight:600; margin-bottom:4px;">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
      <div class="muted">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
      <div style="font-size:12px;color:#9ca3af;margin-top:6px;">(PNG Â· JPG Â· GIF)</div>
      <input id="fileInput" type="file" accept="image/*">
    </div>
  </div>
  <footer>ê¸´ ì´ë¯¸ì§€ë„ ì˜¤ë²„ë ˆì´ë¡œ ì •í™•íˆ í‘œì‹œë©ë‹ˆë‹¤. ê°€ë¡œì„  ê¸°ì¤€ìœ¼ë¡œ ë§í¬ ì¡°ê°ì„ êµ¬ì„±í•©ë‹ˆë‹¤.</footer>
</aside>

<!-- ë©”ì¸ -->
<main id="main">
  <div id="topbar">
    <button id="btnGen" class="primary" disabled>HTML ìƒì„±</button>
    <button id="btnCopy" disabled>ì½”ë“œ ë³µì‚¬</button>
    <button id="btnClearLines">ì„  ëª¨ë‘ ì‚­ì œ</button>
    <span class="pill">ì¼ë°˜ í´ë¦­=ê°€ë¡œ | Shift=ì„¸ë¡œ | Alt=ì‚­ì œ</span>
  </div>

  <div id="workarea">
    <!-- ì¢Œì¸¡: ì´ë¯¸ì§€/ì˜¤ë²„ë ˆì´ -->
    <div id="canvas-container">
      <div id="stage">
        <img id="uploadedImage" alt="ì—…ë¡œë“œ ì´ë¯¸ì§€">
        <!-- ì´ë¯¸ì§€ í¬ê¸°ì™€ ë™ê¸°í™”ë˜ëŠ” ì˜¤ë²„ë ˆì´ -->
        <div id="overlay"></div>
      </div>
    </div>

    <!-- ìš°ì¸¡: ë§í¬/ì½”ë“œ/ë¯¸ë¦¬ë³´ê¸° -->
    <div id="rightpanel">
      <header>ì¡°ê° ë§í¬ ì…ë ¥(ê°€ë¡œì„  ê¸°ì¤€)</header>
      <div id="segments"></div>
      <div id="codebox">
        <button id="btnPreview" disabled>ë¯¸ë¦¬ë³´ê¸° ìƒì„±</button>
        <textarea id="code" placeholder="HTML ìƒì„± í›„ ì½”ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤" readonly></textarea>
      </div>
      <div id="previewwrap">
        <div style="font-weight:600; margin-bottom:8px;">ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="preview"></div>
      </div>
    </div>
  </div>
</main>

<script>
(() => {
  // ìš”ì†Œ ì°¸ì¡°
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const stage = document.getElementById('stage');
  const overlay = document.getElementById('overlay');
  const image = document.getElementById('uploadedImage');
  const container = document.getElementById('canvas-container');

  const segmentsWrap = document.getElementById('segments');
  const btnGen = document.getElementById('btnGen');
  const btnCopy = document.getElementById('btnCopy');
  const btnClearLines = document.getElementById('btnClearLines');
  const btnPreview = document.getElementById('btnPreview');
  const codeTA = document.getElementById('code');
  const preview = document.getElementById('preview');

  // ìƒíƒœ
  let lines = []; // { type: 'h'|'v', perc: number, el: HTMLElement }
  let naturalW = 0, naturalH = 0;
  let segLinks = []; // ê°€ë¡œì„  ê¸°ì¤€ ì¡°ê° ë§í¬

  // ========== ì—…ë¡œë“œ ==========
  function loadFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    image.onload = () => {
      naturalW = image.naturalWidth;
      naturalH = image.naturalHeight;
      stage.style.display = 'inline-block';

      // ì˜¤ë²„ë ˆì´ í¬ê¸°ë¥¼ ì´ë¯¸ì§€ í‘œì‹œ í¬ê¸°ì™€ ë™ê¸°í™”
      syncOverlaySize();
      clearLines(true); // true: ë§í¬ UIë„ ì´ˆê¸°í™”
      btnGen.disabled = false;
      btnPreview.disabled = true;
      btnCopy.disabled = true;
      codeTA.value = '';
      preview.innerHTML = '';
    };
    image.src = url;
  }

  // í´ë¦­ ì—…ë¡œë“œ
  dropzone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    loadFile(f);
  });

  // ë“œë˜ê·¸&ë“œë¡­
  ;['dragenter','dragover'].forEach(ev =>
    dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='copy'; dropzone.classList.add('dragover'); })
  );
  ;['dragleave','dragend','drop'].forEach(ev =>
    dropzone.addEventListener(ev, ()=> dropzone.classList.remove('dragover'))
  );
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f && f.type.startsWith('image/')) loadFile(f);
  });

  // ========== ì˜¤ë²„ë ˆì´/ì¢Œí‘œ ==========

  /** ì´ë¯¸ì§€ í‘œì‹œ í¬ê¸°ì— ì˜¤ë²„ë ˆì´ ë§ì¶”ê¸° */
  function syncOverlaySize(){
    // ì´ë¯¸ì§€ ë Œë”ë§ í¬ê¸°
    const w = image.clientWidth;
    const h = image.clientHeight;
    overlay.style.width = w + 'px';
    overlay.style.height = h + 'px';
    // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜
    overlay.style.left = '0px';
    overlay.style.top  = '0px';
  }

  /** ìŠ¤í…Œì´ì§€ ìƒëŒ€ ì¢Œí‘œ(ìŠ¤í¬ë¡¤ ë³´ì • í¬í•¨) */
  function pointerInOverlay(ev){
    const rect = overlay.getBoundingClientRect();
    const x = ev.clientX - rect.left + container.scrollLeft;
    const y = ev.clientY - rect.top  + container.scrollTop;
    const w = overlay.clientWidth;
    const h = overlay.clientHeight;
    const inside = x >= 0 && y >= 0 && x <= w && y <= h;
    return { x, y, w, h, inside };
  }

  /** í˜„ì¬ ë Œë” í¬ê¸° ë°˜í™˜ */
  function displaySize(){ return { w: overlay.clientWidth, h: overlay.clientHeight }; }

  /** ë¼ì¸ DOM ì¬ë°°ì¹˜(perc -> display px) */
  function layoutLines(){
    const { w, h } = displaySize();
    lines.forEach(l => {
      if (l.type === 'h') {
        l.el.style.top  = (l.perc * h) + 'px';
        l.el.style.left = 0;
        l.el.style.right = 0;
        l.el.className = 'line h-line';
      } else {
        l.el.style.left = (l.perc * w) + 'px';
        l.el.style.top  = 0;
        l.el.style.bottom = 0;
        l.el.className = 'line v-line';
      }
    });
  }

  // ========== ë¼ì¸ ì¶”ê°€/ì‚­ì œ/ë“œë˜ê·¸ ==========

  function createLine(type, perc){
    const el = document.createElement('div');
    el.className = type === 'h' ? 'line h-line' : 'line v-line';
    overlay.appendChild(el);

    const obj = { type, perc, el };
    lines.push(obj);
    layoutLines();
    updateSegmentsUI(); // ê°€ë¡œì„  ë³€ê²½ ë°˜ì˜

    // ë“œë˜ê·¸ ì´ë™
    let dragging = false, startClient = 0, startPerc = 0;
    el.addEventListener('mousedown', (e) => {
      e.preventDefault();
      dragging = true;
      startClient = (type === 'h') ? e.clientY : e.clientX;
      startPerc = obj.perc;

      const onMove = (ev) => {
        if (!dragging) return;
        const { w, h } = displaySize();
        const delta = (type === 'h') ? (ev.clientY - startClient) / h
                                     : (ev.clientX - startClient) / w;
        obj.perc = Math.max(0, Math.min(1, startPerc + delta));
        layoutLines();
        if (type === 'h') updateSegmentsUI(); // ê°€ë¡œì„ ë§Œ ì¡°ê° ì˜í–¥
      };
      const onUp = () => {
        dragging = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      };
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });

    return obj;
  }

  function deleteNearest(x, y){
    if (lines.length === 0) return;
    const { w, h } = displaySize();
    let nearest = null, distMin = Infinity;

    lines.forEach(l => {
      const d = (l.type === 'h')
        ? Math.abs((l.perc * h) - y)
        : Math.abs((l.perc * w) - x);
      if (d < distMin) { distMin = d; nearest = l; }
    });

    if (nearest) {
      nearest.el.remove();
      lines = lines.filter(l => l !== nearest);
      if (nearest.type === 'h') updateSegmentsUI();
    }
  }

  function clearLines(clearLinks=false){
    lines.forEach(l => l.el && l.el.remove());
    lines = [];
    if (clearLinks){
      segLinks = [];
      segmentsWrap.innerHTML = '';
    }
  }

  // ì˜¤ë²„ë ˆì´ í´ë¦­: Alt=ì‚­ì œ / Shift=ì„¸ë¡œ / ê¸°ë³¸=ê°€ë¡œ
  overlay.addEventListener('click', (e) => {
    if (!image.src) return;
    const p = pointerInOverlay(e);
    if (!p.inside) return;

    if (e.altKey){ deleteNearest(p.x, p.y); return; }
    if (e.shiftKey) {
      const perc = p.x / p.w;
      createLine('v', perc);
    } else {
      const perc = p.y / p.h;
      createLine('h', perc);
    }
  });

  // ë¦¬ì‚¬ì´ì¦ˆ(ì´ë¯¸ì§€ í‘œì‹œ í¬ê¸° ë³€ë™) ëŒ€ì‘
  const ro = new ResizeObserver(() => {
    syncOverlaySize();
    layoutLines();
  });
  ro.observe(image);
  ro.observe(stage);

  // ìŠ¤í¬ë¡¤ ì‹œ ì„ /ì˜¤ë²„ë ˆì´ëŠ” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì˜¬ë°”ë¥´ê²Œ ê·¸ë ¤ì§(ì¢Œí‘œ ë³´ì • ë¡œì§ ì‚¬ìš©)

  // ========== ì¡°ê° UI(ê°€ë¡œì„  ê¸°ì¤€) ==========

  function getHorizontalPercsSorted(){
    return lines.filter(l => l.type === 'h').map(l => l.perc).sort((a,b)=>a-b);
  }

  function updateSegmentsUI(){
    const cuts = getHorizontalPercsSorted();
    // ê²½ê³„: 0, cuts..., 1
    const bounds = [0, ...cuts, 1];
    const segCount = Math.max(1, bounds.length - 1);
    const prev = segLinks.slice();
    segLinks = Array.from({length: segCount}, (_,i)=> prev[i] ?? "");

    // ë Œë”
    segmentsWrap.innerHTML = "";
    for (let i=0;i<segCount;i++){
      const hPerc = (bounds[i+1] - bounds[i]) * 100;
      const row = document.createElement('div');
      row.className = 'segrow';
      row.innerHTML = `
        <small>ì¡°ê° ${i+1} <span style="color:#9ca3af">(${hPerc.toFixed(1)}%)</span></small>
        <input type="url" placeholder="https:// ë§í¬ ì…ë ¥" value="${segLinks[i] ?? ""}">
      `;
      row.querySelector('input').addEventListener('input', (ev)=> segLinks[i] = ev.target.value.trim());
      segmentsWrap.appendChild(row);
    }

    // ì¡°ê°ì´ 1ê°œ ì´ìƒì¼ ë•Œë§Œ ë²„íŠ¼ í™œì„±í™”
    const canGen = image.src && segCount >= 1;
    btnGen.disabled = !canGen;
    btnPreview.disabled = true;
    btnCopy.disabled = true;
    codeTA.value = '';
    preview.innerHTML = '';
  }

  // ========== HTML ìƒì„±(ê°€ë¡œ ì¡°ê°ë§Œ) & ë¯¸ë¦¬ë³´ê¸° & ë³µì‚¬ ==========

  async function generateHTML(){
    if (!image.src) return;
    const cutsPerc = getHorizontalPercsSorted();
    const boundsPerc = [0, ...cutsPerc, 1];

    // natural px ê²½ê³„ ê³„ì‚°
    const ys = boundsPerc.map(p => Math.round(p * naturalH));

    // ìº”ë²„ìŠ¤ë¡œ ìŠ¬ë¼ì´ìŠ¤
    const canv = document.createElement('canvas');
    canv.width = naturalW;
    const ctx = canv.getContext('2d');

    const dataURLs = [];
    for (let i=0;i<ys.length-1;i++){
      const top = ys[i];
      const height = ys[i+1] - ys[i];
      if (height <= 0) continue;
      canv.height = height;
      ctx.clearRect(0,0,canv.width,canv.height);
      ctx.drawImage(image, 0, top, naturalW, height, 0, 0, naturalW, height);
      const url = canv.toDataURL('image/png');
      dataURLs.push(url);
    }

    // HTML ì¡°ë¦½
    const pieces = dataURLs.map((src, i) => {
      const href = segLinks[i] || "#";
      return `<a href="${href}" target="_blank" style="display:block;line-height:0;"><img src="${src}" alt="slice-${i+1}" style="display:block;width:100%;height:auto;border:0;"/></a>`;
    }).join("\n");

    const html = `<!-- Generated by Link Slicer -->
<div style="max-width:800px;margin:0 auto;">
${pieces}
</div>`;

    codeTA.value = html;
    btnPreview.disabled = false;
    btnCopy.disabled = false;

    // ë¯¸ë¦¬ë³´ê¸°
    preview.innerHTML = "";
    dataURLs.forEach((src, i) => {
      const a = document.createElement('a');
      a.href = segLinks[i] || "#";
      a.target = "_blank";
      const im = document.createElement('img');
      im.src = src;
      im.alt = `slice-${i+1}`;
      im.style.display = "block";
      im.style.width = "100%";
      im.style.height = "auto";
      a.appendChild(im);
      preview.appendChild(a);
    });
  }

  btnGen.addEventListener('click', generateHTML);
  btnPreview.addEventListener('click', ()=> {
    // ì´ë¯¸ generateHTMLì—ì„œ ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ë¯€ë¡œ ë³„ë„ ì‘ì—… ë¶ˆí•„ìš”
    alert('ë¯¸ë¦¬ë³´ê¸°ê°€ ì•„ë˜ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
  });
  btnCopy.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(codeTA.value);
      btnCopy.textContent = "ë³µì‚¬ë¨";
      setTimeout(()=>btnCopy.textContent="ì½”ë“œ ë³µì‚¬", 1200);
    } catch {
      codeTA.select();
      document.execCommand("copy");
      btnCopy.textContent = "ë³µì‚¬ë¨";
      setTimeout(()=>btnCopy.textContent="ì½”ë“œ ë³µì‚¬", 1200);
    }
  });

  // ì´ˆê¸° ìƒíƒœ
  btnGen.disabled = true;
  btnPreview.disabled = true;
  btnCopy.disabled = true;
})();
</script>
</body>
</html>

